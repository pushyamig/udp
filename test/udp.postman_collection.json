{
  "info": {
    "name": "udp",
    "_postman_id": "e090ccd5-4f23-ecc1-ef10-f2307e844caa",
    "description": "# Requests and tests for Unizin Data Platform (UDP)\n\nAuthor: Lance E Sloan (lsloan@umich.edu)\n\nRequires Postman environment keys:\n* udp_token\n",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "SessionEvent, LoggedIn (via LMS)",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "id": "aeafa23b-4c74-4e41-92d9-9694498e24c3",
            "type": "text/javascript",
            "exec": [
              "eval(pm.variables.get('initRequest')); // Defined in collection pre-request script",
              ""
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "id": "3f1eea73-34e7-4299-9ee6-0c2ee8ec533f",
            "type": "text/javascript",
            "exec": [
              "eval(pm.variables.get('testUtils')); // Defined in collection tests",
              "",
              "pm.test('Request OK', function () {",
              "    expectResponse.status(200);",
              "});",
              "",
              "pm.test('Response contains proper JSON', function () { ",
              "    expectResponse.header('content-type');",
              "    pm.expect(pm.response.headers.get('content-type')).match(/^application\\/json/i);",
              "    expectResponse.json;",
              "});",
              "",
              "pm.test('UDP accepted LC LMS event in \"Gold\" queue', function() {",
              "    var eventId = pm.globals.get('eventId');",
              "    var udpQueueName = 'STREAM-unizin-umich-umich-stream-GoldUMichLectureCapture-dev';",
              "",
              "    expectResponse.jsonBody(eventId + '.' + udpQueueName);",
              "    ",
              "    var jsonData = pm.response.json();",
              "",
              "    // FIXME: Get better definition of the type of ID returned",
              "    // Unizin developers don't have a clear definition of the type of ID returned",
              "    // by GCP.  Will it always be a numeric string?  Always increasing?  Always non-zero?",
              "    pm.expect(jsonData[eventId][udpQueueName]).string(''); // target is *any* string",
              "});",
              ""
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"sensor\": \"leccap_caliper_postman\",\n  \"sendTime\": \"{{timestampUtcIso8601}}\",\n  \"dataVersion\": \"http://purl.imsglobal.org/ctx/caliper/v1p1\",\n  \"data\": [\n    {\n      \"@context\": \"http://purl.imsglobal.org/ctx/caliper/v1p1\",\n      \"id\": \"{{eventId}}\",\n      \"type\": \"SessionEvent\",\n      \"actor\": \"https://mcommunity.umich.edu/#profile:{{udp_uniqname}}\",\n      \"action\": \"LoggedIn\",\n      \"object\": \"https://leccap-beta.engin.umich.edu/#applicationName=Lecture+Capture\",\n      \"eventTime\": \"{{timestampUtcIso8601}}\",\n      \"edApp\": \"https://leccap-beta.engin.umich.edu/#applicationName=Lecture+Capture\",\n      \"group\": {\n        \"academicSession\": \"w18\",\n        \"courseNumber\": \"MFG 599\",\n        \"dateCreated\": \"2013-08-06T17:33:14.000Z\",\n        \"id\": \"https://leccap-beta.engin.umich.edu/leccap/site/i8nnmrgfvqkmcyq8wps#type=CourseOffering\",\n        \"name\": \"Engineering test course\",\n        \"type\": \"CourseOffering\"\n      },\n      \"membership\": {\n        \"id\": \"https://leccap-beta.engin.umich.edu/leccap/site/i8nnmrgfvqkmcyq8wps#type=Membership&member={{udp_uniqname}}\",\n        \"member\": \"https://mcommunity.umich.edu/#profile:{{udp_uniqname}}\",\n        \"organization\": \"https://leccap-beta.engin.umich.edu/leccap/site/i8nnmrgfvqkmcyq8wps#type=CourseOffering\",\n        \"roles\": [\n          \"Learner\"\n        ],\n        \"status\": \"Active\",\n        \"type\": \"Membership\"\n      },\n      \"session\": {\n        \"id\": \"urn:session-id-localized:leccap-beta.engin.umich.edu/44l9rs836ckb6ql21ldvhrmku1\",\n        \"startedAtTime\": \"{{timestampUtcIso8601}}\",\n        \"type\": \"Session\",\n        \"user\": \"https://mcommunity.umich.edu/#profile:{{udp_uniqname}}\"\n      },\n      \"federatedSession\": {\n        \"id\": \"urn:session-id-localized:leccap-beta.engin.umich.edu/lti/oauth_nonce/5a81e2eb557427.65333446\",\n        \"messageParameters\": {\n          \"custom_canvas_course_id\": \"211644\",\n          \"custom_canvas_user_id\": \"151503\",\n          \"lis_course_offering_sourcedid\": \"{{udp_lis_course_offering_sourcedid}}\",\n          \"lis_person_sourcedid\": \"{{udp_lis_person_sourcedid}}\",\n          \"resource_link_id\": \"43814f5790e0379119130a37450d6d126a70b2c1\"\n        },\n        \"type\": \"LtiSession\",\n        \"user\": \"https://mcommunity.umich.edu/#profile:{{udp_uniqname}}\"\n      }\n    }\n  ]\n}\n"
        },
        "url": {
          "raw": "https://unizin-udp-data-umich-dev.appspot.com/",
          "protocol": "https",
          "host": [
            "unizin-udp-data-umich-dev",
            "appspot",
            "com"
          ],
          "path": [
            ""
          ]
        },
        "description": "Requires Postman environment keys:\n* udp_token\n* udp_uniqname\n* udp_lis_course_offering_sourcedid\n* udp_lis_person_sourcedid"
      },
      "response": [
        {
          "id": "a4c1f4e8-e1bf-40f7-a0ef-e9913eb0c970",
          "name": "Ex. 1: SessionEvent, LoggedIn",
          "originalRequest": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"sensor\": \"leccap_caliper_postman\",\n  \"sendTime\": \"{{timestampUtcIso8601}}\",\n  \"dataVersion\": \"http://purl.imsglobal.org/ctx/caliper/v1p1\",\n  \"data\": [\n    {\n  \"@context\": \"http://purl.imsglobal.org/ctx/caliper/v1p1\",\n  \"id\": \"{{eventId}}\",\n  \"type\": \"SessionEvent\",\n  \"actor\": \"https://mcommunity.umich.edu/#profile:{{udp_uniqname}}\",\n  \"action\": \"LoggedIn\",\n  \"object\": \"https://leccap-beta.engin.umich.edu/#applicationName=Lecture+Capture\",\n  \"eventTime\": \"{{timestampUtcIso8601}}\",\n  \"edApp\": \"https://leccap-beta.engin.umich.edu/#applicationName=Lecture+Capture\",\n  \"group\": {\n    \"academicSession\": \"w18\",\n    \"courseNumber\": \"MFG 599\",\n    \"dateCreated\": \"2013-08-06T17:33:14.000Z\",\n    \"id\": \"https://leccap-beta.engin.umich.edu/leccap/site/i8nnmrgfvqkmcyq8wps#type=CourseOffering\",\n    \"name\": \"Engineering test course\",\n    \"type\": \"CourseOffering\"\n  },\n  \"membership\": {\n    \"id\": \"https://leccap-beta.engin.umich.edu/leccap/site/i8nnmrgfvqkmcyq8wps#type=Membership&member={{udp_uniqname}}\",\n    \"member\": \"https://mcommunity.umich.edu/#profile:{{udp_uniqname}}\",\n    \"organization\": \"https://leccap-beta.engin.umich.edu/leccap/site/i8nnmrgfvqkmcyq8wps#type=CourseOffering\",\n    \"roles\": [\n      \"Learner\"\n    ],\n    \"status\": \"Active\",\n    \"type\": \"Membership\"\n  },\n  \"session\": {\n    \"id\": \"urn:session-id-localized:leccap-beta.engin.umich.edu/44l9rs836ckb6ql21ldvhrmku1\",\n    \"startedAtTime\": \"{{timestampUtcIso8601}}\",\n    \"type\": \"Session\",\n    \"user\": \"https://mcommunity.umich.edu/#profile:{{udp_uniqname}}\"\n  },\n  \"federatedSession\": {\n    \"id\": \"urn:session-id-localized:leccap-beta.engin.umich.edu/lti/oauth_nonce/5a81e2eb557427.65333446\",\n    \"messageParameters\": {\n      \"custom_canvas_course_id\": \"211644\",\n      \"custom_canvas_user_id\": \"151503\",\n      \"lis_course_offering_sourcedid\": \"{{udp_lis_course_offering_sourcedid}}\",\n      \"lis_person_sourcedid\": \"{{udp_lis_person_sourcedid}}\",\n      \"resource_link_id\": \"43814f5790e0379119130a37450d6d126a70b2c1\"\n    },\n    \"type\": \"LtiSession\",\n    \"user\": \"https://mcommunity.umich.edu/#profile:{{udp_uniqname}}\"\n  }\n}\n  ]\n}\n"
            },
            "url": {
              "raw": "https://unizin-udp-data-umich-dev.appspot.com/",
              "protocol": "https",
              "host": [
                "unizin-udp-data-umich-dev",
                "appspot",
                "com"
              ],
              "path": [
                ""
              ]
            }
          },
          "status": "OK",
          "code": 200,
          "_postman_previewlanguage": "html",
          "header": [
            {
              "key": "Content-Encoding",
              "value": "gzip",
              "type": "text",
              "enabled": true,
              "name": "Content-Encoding",
              "description": ""
            },
            {
              "key": "Content-Type",
              "value": "text/html; charset=utf-8",
              "type": "text",
              "enabled": true,
              "name": "Content-Type",
              "description": ""
            }
          ],
          "cookie": [],
          "body": "{\"urn:uuid:654e4d31-e56d-45cc-9661-deb323080f7a\": {\"STREAM-unizin-umich-umich-stream-GoldUMichLectureCapture-dev\": \"39447962165063\"}}"
        }
      ]
    },
    {
      "name": "SessionEvent, LoggedIn (non-LMS)",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "id": "aeafa23b-4c74-4e41-92d9-9694498e24c3",
            "type": "text/javascript",
            "exec": [
              "eval(pm.variables.get('initRequest')); // Defined in collection pre-request script",
              ""
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "id": "dcdb1234-e39b-4493-b644-049323571986",
            "type": "text/javascript",
            "exec": [
              "eval(pm.variables.get('testUtils')); // Defined in collection tests",
              "",
              "pm.test('Request OK', function () {",
              "    expectResponse.status(200);",
              "});",
              "",
              "pm.test('Response contains proper JSON', function () { ",
              "    expectResponse.header('content-type');",
              "    pm.expect(pm.response.headers.get('content-type')).match(/^application\\/json/i);",
              "    expectResponse.json;",
              "});",
              "",
              "pm.test('UDP accepted LC non-LMS event in \"Silver\" queue', function() {",
              "    var eventId = pm.globals.get('eventId');",
              "    var udpQueueName = 'STREAM-unizin-umich-umich-stream-Silver-dev';",
              "",
              "    expectResponse.jsonBody(eventId + '.' + udpQueueName);",
              "",
              "    var jsonData = pm.response.json();",
              "    ",
              "    // FIXME: Get better definition of the type of ID returned",
              "    // Unizin developers don't have a clear definition of the type of ID returned",
              "    // by GCP.  Will it always be a numeric string?  Always increasing?  Always non-zero?",
              "    pm.expect(jsonData[eventId][udpQueueName]).string(''); // target is *any* string",
              "});",
              ""
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"sensor\": \"leccap_caliper_postman\",\n  \"sendTime\": \"{{timestampUtcIso8601}}\",\n  \"dataVersion\": \"http://purl.imsglobal.org/ctx/caliper/v1p1\",\n  \"data\": [\n    {\n      \"@context\": \"http://purl.imsglobal.org/ctx/caliper/v1p1\",\n      \"id\": \"{{eventId}}\",\n      \"type\": \"SessionEvent\",\n      \"actor\": \"https://mcommunity.umich.edu/#profile:{{udp_uniqname}}\",\n      \"action\": \"LoggedIn\",\n      \"object\": \"https://leccap-beta.engin.umich.edu/#applicationName=Lecture+Capture\",\n      \"eventTime\": \"{{timestampUtcIso8601}}\",\n      \"edApp\": \"https://leccap-beta.engin.umich.edu/#applicationName=Lecture+Capture\",\n      \"group\": {\n        \"academicSession\": \"w18\",\n        \"courseNumber\": \"MFG 599\",\n        \"dateCreated\": \"2013-08-06T17:33:14.000Z\",\n        \"id\": \"https://leccap-beta.engin.umich.edu/leccap/site/i8nnmrgfvqkmcyq8wps#type=CourseOffering\",\n        \"name\": \"Engineering test course\",\n        \"type\": \"CourseOffering\"\n      },\n      \"membership\": {\n        \"id\": \"https://leccap-beta.engin.umich.edu/leccap/site/i8nnmrgfvqkmcyq8wps#type=Membership&member={{udp_uniqname}}\",\n        \"member\": \"https://mcommunity.umich.edu/#profile:{{udp_uniqname}}\",\n        \"organization\": \"https://leccap-beta.engin.umich.edu/leccap/site/i8nnmrgfvqkmcyq8wps#type=CourseOffering\",\n        \"roles\": [\n          \"Learner\"\n        ],\n        \"status\": \"Active\",\n        \"type\": \"Membership\"\n      },\n      \"session\": {\n        \"id\": \"urn:session-id-localized:leccap-beta.engin.umich.edu/44l9rs836ckb6ql21ldvhrmku1\",\n        \"startedAtTime\": \"{{timestampUtcIso8601}}\",\n        \"type\": \"Session\",\n        \"user\": \"https://mcommunity.umich.edu/#profile:{{udp_uniqname}}\"\n      }\n    }\n  ]\n}\n"
        },
        "url": {
          "raw": "https://unizin-udp-data-umich-dev.appspot.com/",
          "protocol": "https",
          "host": [
            "unizin-udp-data-umich-dev",
            "appspot",
            "com"
          ],
          "path": [
            ""
          ]
        },
        "description": "Requires Postman environment keys:\n* udp_token\n* udp_uniqname\n* udp_lis_course_offering_sourcedid\n* udp_lis_person_sourcedid"
      },
      "response": [
        {
          "id": "3104ee3b-bd31-4d0e-9e20-91023ef00a80",
          "name": "Ex. 1: SessionEvent, LoggedIn (non-LMS)",
          "originalRequest": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json",
                "disabled": false
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"sensor\": \"leccap_caliper_postman\",\n  \"sendTime\": \"{{timestampUtcIso8601}}\",\n  \"dataVersion\": \"http://purl.imsglobal.org/ctx/caliper/v1p1\",\n  \"data\": [\n    {\n      \"@context\": \"http://purl.imsglobal.org/ctx/caliper/v1p1\",\n      \"id\": \"{{eventId}}\",\n      \"type\": \"SessionEvent\",\n      \"actor\": \"https://mcommunity.umich.edu/#profile:{{udp_uniqname}}\",\n      \"action\": \"LoggedIn\",\n      \"object\": \"https://leccap-beta.engin.umich.edu/#applicationName=Lecture+Capture\",\n      \"eventTime\": \"{{timestampUtcIso8601}}\",\n      \"edApp\": \"https://leccap-beta.engin.umich.edu/#applicationName=Lecture+Capture\",\n      \"group\": {\n        \"academicSession\": \"w18\",\n        \"courseNumber\": \"MFG 599\",\n        \"dateCreated\": \"2013-08-06T17:33:14.000Z\",\n        \"id\": \"https://leccap-beta.engin.umich.edu/leccap/site/i8nnmrgfvqkmcyq8wps#type=CourseOffering\",\n        \"name\": \"Engineering test course\",\n        \"type\": \"CourseOffering\"\n      },\n      \"membership\": {\n        \"id\": \"https://leccap-beta.engin.umich.edu/leccap/site/i8nnmrgfvqkmcyq8wps#type=Membership&member={{udp_uniqname}}\",\n        \"member\": \"https://mcommunity.umich.edu/#profile:{{udp_uniqname}}\",\n        \"organization\": \"https://leccap-beta.engin.umich.edu/leccap/site/i8nnmrgfvqkmcyq8wps#type=CourseOffering\",\n        \"roles\": [\n          \"Learner\"\n        ],\n        \"status\": \"Active\",\n        \"type\": \"Membership\"\n      },\n      \"session\": {\n        \"id\": \"urn:session-id-localized:leccap-beta.engin.umich.edu/44l9rs836ckb6ql21ldvhrmku1\",\n        \"startedAtTime\": \"{{timestampUtcIso8601}}\",\n        \"type\": \"Session\",\n        \"user\": \"https://mcommunity.umich.edu/#profile:{{udp_uniqname}}\"\n      }\n    }\n  ]\n}\n"
            },
            "url": {
              "raw": "https://unizin-udp-data-umich-dev.appspot.com/",
              "protocol": "https",
              "host": [
                "unizin-udp-data-umich-dev",
                "appspot",
                "com"
              ],
              "path": [
                ""
              ]
            }
          },
          "status": "OK",
          "code": 200,
          "_postman_previewlanguage": "html",
          "header": [
            {
              "key": "Content-Encoding",
              "value": "gzip",
              "type": "text",
              "enabled": true,
              "name": "Content-Encoding",
              "description": ""
            },
            {
              "key": "Content-Type",
              "value": "text/html; charset=utf-8",
              "type": "text",
              "enabled": true,
              "name": "Content-Type",
              "description": ""
            }
          ],
          "cookie": [],
          "body": "{\"urn:uuid:654e4d31-e56d-45cc-9661-deb323080f7a\": {\"STREAM-unizin-umich-umich-stream-Silver-dev\": \"39447962165063\"}}"
        }
      ]
    }
  ],
  "auth": {
    "type": "bearer",
    "bearer": [
      {
        "key": "token",
        "value": "{{udp_token}}",
        "type": "string"
      }
    ]
  },
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "id": "5dca8aaa-9102-4b9a-afc4-4e38ae5bbe12",
        "type": "text/javascript",
        "exec": [
          "// Postman (v5.5.3) doesn't pass definitions from collection to folder to request.",
          "// To get unique values (timestamp, ID, etc.) in each request, define them here.",
          "// Then in the request's pre-request script, use:",
          "//      eval(pm.variables.get('initRequest'));",
          "function initRequest() {",
          "    pm.globals.set('timestampUtcIso8601', (new Date()).toISOString());",
          "    pm.globals.set('randomString', Math.random().toString(26).substring(2).replace(/[0-9]/g, c => 'qrstuvwxyz'[c]));",
          "",
          "    uuid = require('uuid');",
          "    pm.globals.set('eventId', 'urn:uuid:' + uuid.v4());",
          "    ",
          "    // Remember: Functions must be defined this way and without `var`, `const`, etc.",
          "    fubar = function() {return 'fubar';}",
          "}",
          "pm.globals.set(initRequest.name, initRequest.toString() + initRequest.name + '()');",
          ""
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "id": "42eee30c-559d-4d33-abb9-64aa5bcccceb",
        "type": "text/javascript",
        "exec": [
          "function testUtils() {",
          "    expectResponse = pm.expect(pm.response);",
          "}",
          "pm.globals.set(testUtils.name, testUtils.toString() + testUtils.name + '()');",
          ""
        ]
      }
    }
  ]
}